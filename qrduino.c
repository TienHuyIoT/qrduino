#include <stdio.h>

unsigned char jpeg0[] = {
    0xff, 0xd8,
    0xff, 0xe0, 0x00, 0x10, 0x4a, 0x46, 0x49, 0x46, 0x00,
    0x01, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,

    0xFF, 0xDB, 0x00, 0x43, 0x00,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,

    0xff, 0xc1, 0x00, 0x0b, 0x08,
    // address 0x5e
    0x00, 0x80,                 // height
    0x00, 0x80,                 // width
    0x01, 0x01, 0x11, 0x00,
    // DC table
    0xff, 0xc4, 0x00, 0x15, 0x00,
    1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    6, 0,
    // AC Table
    0xff, 0xc4, 0x00, 0x14, 0x10,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
    // Image scan header
    0xff, 0xda, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3f, 0x00
};

#include "qrencode.h"

#include <string.h>
int main(int argc, char *argv[])
{
    unsigned char x, y;
    char *c;
    unsigned width, height, j, k;
    width = height = WD;

    c = "Hello from HarleyHacking";
    if( argc > 1 )
        c = argv[1];

    initeccsize( 1, strlen(c));
    initframe();
    strcpy((char *)strinbuf, c );
    qrencode();
    // set height and width in header
    jpeg0[0x5e] = WD >> 5;
    jpeg0[0x5f] = WD << 3;
    jpeg0[0x60] = WD >> 5;
    jpeg0[0x61] = WD << 3;
    // write out header
    fwrite(jpeg0, 1, sizeof(jpeg0), stdout);
    // put half full scale, 3e for white, 40 for black
    k = j = QRBIT(0,0);
    putchar(j ? 0x3e : 0x40);
    for (y = 0; y < WD; y++) 
        for (x = 0; x < WD; x++)  {
            if( x+y== 0)
                continue;
            j = QRBIT(x,y);
            if (k == j) {
                putchar(0x80);      // code for no change
                continue;
            }
            putchar(j ? 0 : 0x7e);   // full scale flip
            k = j;
        }
    putchar(0x80);              // one last for EOF
    putchar(0xFF);              // end marker
    putchar(0xd9);
    return 0;
}
